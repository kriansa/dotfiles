#!/usr/bin/env bash

## Creates boilerplate files for your Ruby project
##
## Usage: ruby-init [<ruby_version>] [<copyright_name>] [<boilerplate_path>]
##

# Error handler
trap error_handler ERR

function error_handler {
  EXIT_CODE=$?

  echo
  echo "An error has occurred!"
  echo "Exit code: ${EXIT_CODE}"
  exit 1
}

function help {
  echo "Usage: $0 [<ruby_version>] [<copyright_name>] [<boilerplate_path>]"
  exit
}

if [[ $1 == "help" || $1 == "--help" ]]; then
  help
fi

# Input variables
RUBY_VERSION=$1
COPYRIGHT_NAME=$2
BOILERPLATE_DIR=$3

# Set default variables
: ${RUBY_VERSION:="2.3.3"}
: ${COPYRIGHT_NAME:="$(gpg2 -K $GPG_MAIN_KEY | grep uid | head -1 | sed 's/uid.*\] //' | sed 's/ <.*>//')"}
: ${BOILERPLATE_DIR:="$(dirname $(dirname $0))/data/project-boilerplate"}

# Year
YEAR=$(date +%Y)

for file in $(ls -A1 $BOILERPLATE_DIR); do
  cat $BOILERPLATE_DIR/$file | sed "s/<RUBY_VERSION>/$RUBY_VERSION/g" | sed "s/<OWNER>/$COPYRIGHT_NAME/g" | sed "s/<YEAR>/$YEAR/g" > $file
done

echo "Started project with Ruby v$RUBY_VERSION"
