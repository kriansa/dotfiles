#!/usr/bin/env bash

main() {
  trap exit INT

  # Running this for the first time
  if ! command -v uv &>/dev/null; then
    echo "uv is not installed, installing..."

    # When on MacOS, set the path to the system python
    # That will allow us to use `pip3`
    if [[ "$(uname)" = "Darwin" ]]; then
      PATH="$(python3 -m site --user-base)/bin:$PATH"
    fi

    # Create a temporary venv to install uv
    local temp_venv; temp_venv="$(mktemp -d)"
    trap "rm -rf \"$temp_venv\"" EXIT
    python3 -m venv "$temp_venv"
    source "$temp_venv/bin/activate"

    # Install uv (a package manager for Python)
    pip3 install uv
  fi

  # Install/upgrade uv using `uv` itself
  uv tool install --no-managed-python --upgrade --force uv

  # Install packages using latest python installed
  while IFS= read -r package; do
    echo "Updating package $package"
    uv tool install --no-managed-python --upgrade "$package"
  done < "$HOME/.dotfiles/modules/python/data/requirements.txt"

  # Update other packages not installed via requirements.txt
  uv tool upgrade --all

  # Then install Python 3.12-specific packages
  uv tool install --python 3.12 --with "aider-chat[browser]" "aider-chat"
}

main "$@"
