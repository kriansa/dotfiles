#!/usr/bin/env bash

main() {
  trap exit INT

  # Running this for the first time
  if ! command -v uv &>/dev/null; then
    echo "uv is not installed, installing..."

    # When on MacOS, set the path to the system python
    # That will allow us to use `pip3`
    if [[ "$(uname)" = "Darwin" ]]; then
      PATH="$(python3 -m site --user-base)/bin:$PATH"
    fi

    # Install uv on system python (a package manager for Python)
    pip3 install --user --no-warn-script-location --upgrade uv
    uninstall_uv_pip=1
  fi

  # Install/upgrade uv using `uv` itself
  uv tool install --no-managed-python --upgrade --force uv

  # Install packages using latest python installed
  while IFS= read -r package; do
    echo "Updating package $package"
    uv tool install --no-managed-python --upgrade "$package"
  done < "$HOME/.dotfiles/modules/python/data/requirements.txt"

  # Update other packages not installed via requirements.txt
  uv tool upgrade --all

  # Then install Python 3.12-specific packages
  uv tool install --python 3.12 --with "aider-chat[browser]" "aider-chat"

  if [[ $uninstall_uv_pip -eq 1 ]]; then
    echo "Removing uv pip package"
    pip3 uninstall --yes uv
  fi
}

main "$@"
