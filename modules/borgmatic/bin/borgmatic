#!/usr/bin/env bash
# vim: noexpandtab tabstop=2
#
# This is a wrapper around borgmatic so that the `list` subcommand also executes hooks.

main() {
	# Set HOME to whoever is invoking sudo, or in case this varibale isn't set, just set it to ~
	eval HOME=~$SUDO_USER

	# Finds out where borgmatic config file is
	if is_list_cmd "$@"; then
		run_hooks before
		borgmatic "$@"; status=$?
		run_hooks after

		return $status
	else
		borgmatic "$@"
	fi
}

borgmatic() {
	/usr/bin/borgmatic "$@"
}

is_list_cmd() {
	cmd=$1

	# This is limited to checking whether list is in the first position of the args list. Ensure that
	# you only call `borgmatic list` with options after the subcommand (i.e. borgmatic list -c ...)
	[ "$cmd" = "list" ] || [ "$cmd" = "--list" ] || [ "$cmd" == "-l" ]
}

run_hooks() {
	local type=$1
	local config_path="$HOME/.config/borgmatic/config.yaml"

	while read -r hook; do
		eval "$hook" || {
			echo "Failure while running ${type}_everything hook on '$config_path'"
			exit 1
		}
	done < <(yq -r ".hooks.${type}_everything[]" "$config_path")
}

main "$@"
