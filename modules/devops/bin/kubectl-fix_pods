#!/usr/bin/env bash

help() {
  echo "Fix pods stuck in Terminating or CrashLoopBackOff state"
  echo "  You can use any option supported by kubectl, such as --context, --namespace, etc."
  echo
  echo "Usage:"
  echo "  kubectl fix-pods [OPTIONS]"
}

main() {
  trap exit INT
  parse_args "$@"

  kubectl get "$@" pods | grep -E "(Terminating|CrashLoopBackOff)" | awk '{ print $1 }' | \
    xargs kubectl patch "$@" pod -p '{"metadata":{"finalizers":null}}'
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case $1 in
      -h|--help)
        help && exit
        ;;
      *) shift
    esac
  done
}

main "$@"
